# .github/workflows/ci.yml

# Workflow 名稱
name: CI

# 觸發條件：當有 pull_request 推送到 main 分支時觸發
on:
  pull_request:
    branches: [main]

# Job 設定
jobs:
  build-and-test:
    # Job 名稱
    name: Build and Test
    # 運行環境
    runs-on: ubuntu-latest

    # 【新增】設定環境變數，從 GitHub Secrets 注入
    # 這樣之後的 npm run build/test 都能讀取到 process.env.BACKEND_API_URL 等變數
    env:
      BACKEND_API_URL: ${{ secrets.BACKEND_API_URL }}
      BACKEND_API_KEY: ${{ secrets.BACKEND_API_KEY }}

    # 執行步驟
    steps:
      # Step 1: Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      # Step 3: Install Dependencies
      - name: Install Dependencies
        run: npm ci

      # Step 4: Run Lint
      - name: Run Lint
        run: npm run lint

      # Step 5: Run TypeScript Check (Next.js build includes this)
      # Next.js 建置時可能會檢查 API Route，因此這裡需要上述的 env
      - name: Run TypeScript Check
        run: npm run build

      # Step 6: Run Unit & Component Tests
      # 測試如果涉及 API 呼叫或模擬環境變數，也需要上述的 env
      - name: Run Unit & Component Tests
        run: npm run test

      # Step 7: Run E2E Tests
      # 後端上線先關閉 CI 中的 E2E
      # - name: Install Playwright Browsers
      #   run: npx playwright install --with-deps
      # - name: Run E2E Tests
      #   run: npx playwright test
